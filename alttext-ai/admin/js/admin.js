!function(){"use strict";const{__:e}=wp.i18n;function t(t){"all"===t.mode&&jQuery("[data-bulk-generate-mode-all]").prop("checked",!0),"1"===t.onlyAttached&&jQuery("[data-bulk-generate-only-attached]").prop("checked",!0),"1"===t.onlyNew&&jQuery("[data-bulk-generate-only-new]").prop("checked",!0),"1"===t.wcProducts&&jQuery("[data-bulk-generate-wc-products]").prop("checked",!0),"1"===t.wcOnlyFeatured&&jQuery("[data-bulk-generate-wc-only-featured]").prop("checked",!0),t.keywords&&t.keywords.length>0&&jQuery("[data-bulk-generate-keywords]").val(t.keywords.join(", ")),t.negativeKeywords&&t.negativeKeywords.length>0&&jQuery("[data-bulk-generate-negative-keywords]").val(t.negativeKeywords.join(", ")),jQuery(".atai-recovery-banner").remove(),function(t){if(window.atai.recoveryBannerShown)return;window.atai.recoveryBannerShown=!0;const a=Math.round((Date.now()-t.timestamp)/1e3/60),r=a<5?e("Previous bulk processing session found. The form has been restored to continue where you left off.","alttext-ai"):e("Previous bulk processing session found from %d minutes ago. The form has been restored to continue where you left off.","alttext-ai").replace("%d",a),i=t.lastPostId>0?e(" Processing will resume after image ID %d.","alttext-ai").replace("%d",t.lastPostId):"",n=jQuery(`\n      <div class="notice notice-info is-dismissible atai-recovery-banner" style="margin: 10px 0;">\n        <p style="margin: 0;">${r+i}</p>\n      </div>\n    `);jQuery("#bulk-generate-form").prepend(n),n.on("click",".notice-dismiss",(function(){try{localStorage.removeItem("atai_bulk_progress"),window.atai.lastPostId=0,window.atai.hasRecoveredSession=!1,window.atai.isContinuation=!1,window.atai.progressCurrent=0,window.atai.progressSuccessful=0,window.atai.retryCount=0,jQuery("#atai-start-over-button").remove();const t=jQuery("[data-bulk-generate-start]");if(t.length){const a=t.closest(".wrap").find("[data-bulk-generate-progress-bar]").data("max")||0;if(a>0){const r=1===a?e("Generate Alt Text for %d Image","alttext-ai").replace("%d",a):e("Generate Alt Text for %d Images","alttext-ai").replace("%d",a);t.text(r)}}}catch(e){}n.remove()}))}(t);const a=jQuery("[data-bulk-generate-start]");if(a.length){const r=t.progressCurrent||0,i=t.progressMax||0,n=Math.max(0,i-r);if(n>0){const t=e("Continue: %d remaining images","alttext-ai").replace("%d",n);a.text(t)}const s=jQuery(`\n        <button type="button" class="atai-button black ml-3" id="atai-start-over-button">\n          ${e("Start Over","alttext-ai")}\n        </button>\n      `);a.parent().append(s),s.on("click",(function(){try{localStorage.removeItem("atai_bulk_progress"),window.atai.lastPostId=0,window.atai.hasRecoveredSession=!1,window.atai.isContinuation=!1,window.atai.remainingImages=null,window.atai.progressCurrent=0,window.atai.progressSuccessful=0,window.atai.retryCount=0,window.location.reload()}catch(e){}}))}window.atai.isContinuation=!0}window.atai=window.atai||{postsPerPage:1,lastPostId:0,intervals:{},redirectUrl:"",isProcessing:!1,retryCount:0,maxRetries:5},window.atai.hideButtons=function(){jQuery("#atai-start-over-button").addClass("atai-hidden"),jQuery("[data-bulk-generate-start]").addClass("atai-hidden")},window.atai.showButtons=function(){jQuery("#atai-start-over-button").removeClass("atai-hidden"),jQuery("[data-bulk-generate-start]").removeClass("atai-hidden")};try{const e=localStorage.getItem("atai_bulk_progress");if(e){const a=JSON.parse(e);window.atai.lastPostId=a.lastPostId||0,window.atai.hasRecoveredSession=!0,a.mode&&(window.atai.bulkGenerateMode=a.mode),a.onlyAttached&&(window.atai.bulkGenerateOnlyAttached=a.onlyAttached),a.onlyNew&&(window.atai.bulkGenerateOnlyNew=a.onlyNew),a.wcProducts&&(window.atai.bulkGenerateWCProducts=a.wcProducts),a.wcOnlyFeatured&&(window.atai.bulkGenerateWCOnlyFeatured=a.wcOnlyFeatured),a.keywords&&(window.atai.bulkGenerateKeywords=a.keywords),a.negativeKeywords&&(window.atai.bulkGenerateNegativeKeywords=a.negativeKeywords),void 0!==a.progressCurrent&&(window.atai.progressCurrent=a.progressCurrent),void 0!==a.progressSuccessful&&(window.atai.progressSuccessful=a.progressSuccessful),void 0!==a.progressMax&&(window.atai.progressMax=a.progressMax),void 0!==a.progressSkipped&&(window.atai.progressSkipped=a.progressSkipped),setTimeout((()=>{const e=jQuery("[data-bulk-generate-progress-current]"),t=jQuery("[data-bulk-generate-progress-successful]"),r=jQuery("[data-bulk-generate-progress-skipped]"),i=jQuery("[data-bulk-generate-progress-max]");e.length&&e.text(a.progressCurrent||0),t.length&&t.text(a.progressSuccessful||0),r.length&&r.text(a.progressSkipped||0),i.length&&a.progressMax&&i.text(a.progressMax)}),100),setTimeout((()=>{t(a)}),800)}}catch(e){}function a(t,a=[]){if(!t){const t=new Error(e("Attachment ID is missing","alttext-ai"));return console.error("singleGenerateAJAX error:",t),Promise.reject(t)}return new Promise(((e,r)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai_single_generate",security:wp_atai.security_single_generate,attachment_id:t,keywords:a},url:wp_atai.ajax_url,success:function(t){e(t)},error:function(e){const t=new Error("AJAX request failed");console.error("singleGenerateAJAX failed:",t),r(t)}})}))}function r(){window.atai.isProcessing||(window.atai.isProcessing=!0,jQuery.ajax({type:"post",dataType:"json",data:{action:"atai_bulk_generate",security:wp_atai.security_bulk_generate,posts_per_page:window.atai.postsPerPage,last_post_id:window.atai.lastPostId,keywords:window.atai.bulkGenerateKeywords,negativeKeywords:window.atai.bulkGenerateNegativeKeywords,mode:window.atai.bulkGenerateMode,onlyAttached:window.atai.bulkGenerateOnlyAttached,onlyNew:window.atai.bulkGenerateOnlyNew,wcProducts:window.atai.bulkGenerateWCProducts,wcOnlyFeatured:window.atai.bulkGenerateWCOnlyFeatured,batchId:window.atai.bulkGenerateBatchId},url:wp_atai.ajax_url,success:function(t){try{if("url_access_fix"===t.action_required&&!window.atai.bypassUrlAccessError)return void function(t){window.atai.isProcessing=!1,window.atai.progressHeading.length&&window.atai.progressHeading.text(e("URL Access Error","alttext-ai"));const a=`\n      <div class="atai-url-access-notification bg-amber-900/5 p-px rounded-lg mb-6">\n        <div class="bg-amber-50 rounded-lg p-4">\n          <div class="flex items-start">\n            <div class="flex-shrink-0">\n              <svg class="size-5 mt-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />\n              </svg>\n            </div>\n            <div class="ml-3 flex-1">\n              <h3 class="text-base font-semibold text-amber-800 mb-2">${e("Image Access Problem","alttext-ai")}</h3>\n              <p class="text-sm text-amber-700 mb-3">${e("Some of your image URLs are not accessible to our servers. This can happen due to:","alttext-ai")}</p>\n              <ul class="text-sm text-amber-700 mb-3 ml-4 list-disc space-y-1">\n                <li>${e("Server firewalls or security restrictions","alttext-ai")}</li>\n                <li>${e("Local development environments (localhost)","alttext-ai")}</li>\n                <li>${e("Password-protected or staging sites","alttext-ai")}</li>\n                <li>${e("VPN or private network configurations","alttext-ai")}</li>\n              </ul>\n              <p class="text-sm text-amber-800">${e("Switching to direct upload mode will send your images securely to our servers instead of using URLs, which resolves this issue.","alttext-ai")}</p>\n            </div>\n          </div>\n          <div class="mt-4 flex gap-3">\n            <button type="button" id="atai-fix-url-access" class="atai-button blue">\n              ${e("Update Setting Now","alttext-ai")}\n            </button>\n            <button type="button" id="atai-continue-anyway" class="atai-button black">\n              ${e("Continue Anyway","alttext-ai")}\n            </button>\n            <button type="button" id="atai-dismiss-url-notification" class="atai-button white">\n              ${e("Dismiss","alttext-ai")}\n            </button>\n          </div>\n        </div>\n      </div>\n    `,i=jQuery("[data-bulk-generate-progress-wrapper]");i.length&&(i.after(a),jQuery("#atai-fix-url-access").on("click",(function(){jQuery.post(wp_atai.ajax_url,{action:"atai_update_public_setting",security:wp_atai.security_update_public_setting,atai_public:"no"},(function(e){e.success&&window.location.reload()})).fail((function(e,t,a){console.error("AJAX request failed:",a),window.location.reload()}))})),jQuery("#atai-continue-anyway").on("click",(function(){console.log("Continue Anyway clicked"),window.atai.bypassUrlAccessError=!0,jQuery(".atai-url-access-notification").remove(),window.atai.progressHeading.length&&window.atai.progressHeading.text(e("Processing images...","alttext-ai")),isNaN(window.atai.progressCurrent)&&(window.atai.progressCurrent=0),isNaN(window.atai.progressSuccessful)&&(window.atai.progressSuccessful=0),isNaN(window.atai.progressSkipped)&&(window.atai.progressSkipped=0),window.atai.isProcessing=!1,console.log("Set bypass flag and calling bulkGenerateAJAX..."),r()})),jQuery("#atai-dismiss-url-notification").on("click",(function(){jQuery(".atai-url-access-notification").remove()})))}(t.message);if("url_access_fix"===t.action_required&&window.atai.bypassUrlAccessError){console.log("Bypassing URL access error, current lastPostId:",window.atai.lastPostId,"response lastPostId:",t.last_post_id),window.atai.progressCurrent+=1,window.atai.progressSkipped=(window.atai.progressSkipped||0)+1,window.atai.lastPostId=t.last_post_id||window.atai.lastPostId,window.atai.urlAccessErrorCount||(window.atai.urlAccessErrorCount=0),window.atai.urlAccessErrorCount++,console.log("Updated lastPostId to:",window.atai.lastPostId,"continuing in 500ms...");try{const e={lastPostId:window.atai.lastPostId,mode:window.atai.bulkGenerateMode,onlyAttached:window.atai.bulkGenerateOnlyAttached,onlyNew:window.atai.bulkGenerateOnlyNew,wcProducts:window.atai.bulkGenerateWCProducts,wcOnlyFeatured:window.atai.bulkGenerateWCOnlyFeatured,keywords:window.atai.bulkGenerateKeywords,negativeKeywords:window.atai.bulkGenerateNegativeKeywords,batchId:window.atai.bulkGenerateBatchId,progressCurrent:window.atai.progressCurrent,progressSuccessful:window.atai.progressSuccessful,progressMax:window.atai.progressMax,progressSkipped:window.atai.progressSkipped||0};localStorage.setItem("atai_bulk_progress",JSON.stringify(e))}catch(e){}return window.atai.progressCurrentEl.length&&window.atai.progressCurrentEl.text(window.atai.progressCurrent),window.atai.progressSkippedEl.length&&window.atai.progressSkippedEl.text(window.atai.progressSkipped),window.atai.progressLastPostId.length&&window.atai.progressLastPostId.text(window.atai.lastPostId),window.atai.isProcessing=!1,void setTimeout(r,500)}if(window.atai.retryCount=0,window.atai.progressHeading.length){const t=window.atai.progressHeading.text();(t.includes("Retrying")||t.includes("Server error"))&&window.atai.progressHeading.text(e("Processing images...","alttext-ai"))}window.atai.progressCurrent+=t.process_count,window.atai.progressSuccessful+=t.success_count,void 0!==t.skipped_count&&(window.atai.progressSkipped=(window.atai.progressSkipped||0)+t.skipped_count,window.atai.progressSkippedEl&&window.atai.progressSkippedEl.text(window.atai.progressSkipped)),window.atai.lastPostId=t.last_post_id,window.atai.progressBarEl.length&&window.atai.progressBarEl.data("current",window.atai.progressCurrent),window.atai.progressLastPostId.length&&window.atai.progressLastPostId.text(window.atai.lastPostId);try{const e={lastPostId:window.atai.lastPostId,timestamp:Date.now(),mode:window.atai.bulkGenerateMode,onlyAttached:window.atai.bulkGenerateOnlyAttached,onlyNew:window.atai.bulkGenerateOnlyNew,wcProducts:window.atai.bulkGenerateWCProducts,wcOnlyFeatured:window.atai.bulkGenerateWCOnlyFeatured,keywords:window.atai.bulkGenerateKeywords,negativeKeywords:window.atai.bulkGenerateNegativeKeywords,progressCurrent:window.atai.progressCurrent,progressSuccessful:window.atai.progressSuccessful,progressMax:window.atai.progressMax,progressSkipped:window.atai.progressSkipped||0};localStorage.setItem("atai_bulk_progress",JSON.stringify(e))}catch(e){}window.atai.progressCurrentEl.length&&window.atai.progressCurrentEl.text(window.atai.progressCurrent),window.atai.progressSuccessfulEl.length&&window.atai.progressSuccessfulEl.text(window.atai.progressSuccessful);const a=100*window.atai.progressCurrent/window.atai.progressMax;if(window.atai.progressBarEl.length&&window.atai.progressBarEl.css("width",a+"%"),window.atai.progressPercent.length&&window.atai.progressPercent.text(Math.round(a)+"%"),t.recursive)window.atai.retryCount=0,window.atai.isProcessing=!1,setTimeout((()=>{r()}),500);else{window.atai.retryCount=0,window.atai.isProcessing=!1,window.atai.progressButtonCancel.length&&window.atai.progressButtonCancel.hide(),window.atai.progressBarWrapper.length&&window.atai.progressBarWrapper.hide(),window.atai.progressButtonFinished.length&&window.atai.progressButtonFinished.show(),window.atai.progressHeading.length&&window.atai.progressHeading.text(t.message||e("Update complete!","alttext-ai"));const a=jQuery("[data-bulk-generate-progress-subtitle]");if(a.length){let e=t.subtitle&&t.subtitle.trim()?t.subtitle:"";if(window.atai.urlAccessErrorCount>0){const t=1===window.atai.urlAccessErrorCount?"1 URL access failure":`${window.atai.urlAccessErrorCount} URL access failures`,a=`${t} (<a href="${`${wp_atai.settings_page_url}#atai_error_logs_container`}" target="_blank" style="color: inherit; text-decoration: underline;">see error logs for details</a>)`;e?e+=`, ${a}`:e=`Skip reasons: ${a}`}e?(a.attr("data-skipped","").find("span").html(e),a.show()):a.hide()}window.atai.redirectUrl=t?.redirect_url;try{localStorage.removeItem("atai_bulk_progress")}catch(e){}}}catch(e){console.error("bulkGenerateAJAX error:",e),i(e)}},error:function(e){try{const t=new Error("AJAX request failed during bulk generation");console.error("bulkGenerateAJAX AJAX failed:",t.message),i(t,e)}catch(t){i(new Error("AJAX request failed during bulk generation"),e)}}}))}function i(t,a){const i=a&&(a.status>=500||0===a.status||408===a.status||405===a.status||502===a.status||503===a.status||504===a.status),n=t.message.includes("timeout")||t.message.includes("network")||t.message.includes("failed"),s=t.message.includes("AJAX request failed"),o=i||n||s;if(console.error("Bulk generation error details:",{errorMessage:t.message,responseStatus:a?.status,isServerError:i,hasTimeoutError:n,isAjaxFailure:s,isRetryable:o,retryCount:window.atai.retryCount,maxRetries:window.atai.maxRetries}),o&&window.atai.retryCount<window.atai.maxRetries){window.atai.retryCount++;const t=1e3*Math.pow(2,window.atai.retryCount);if(console.error(`Retrying bulk generation (attempt ${window.atai.retryCount}/${window.atai.maxRetries}) after ${t}ms delay`),window.atai.progressHeading.length){const a=e("Server error encountered (attempt %1$d/%2$d)","alttext-ai").replace("%1$d",window.atai.retryCount).replace("%2$d",window.atai.maxRetries),r=e("Retrying in %d seconds...","alttext-ai").replace("%d",Math.ceil(t/1e3));window.atai.progressHeading.html(`\n          <div style="line-height: 1.4;">\n            <div style="font-weight: 600; margin-bottom: 4px;">${a}</div>\n            <div style="font-size: 0.9em; color: #666;">${r}</div>\n          </div>\n        `)}setTimeout((()=>{if(console.error("Executing retry attempt",window.atai.retryCount),window.atai.progressHeading.length){const t=e("Retrying bulk generation (attempt %1$d/%2$d)...","alttext-ai").replace("%1$d",window.atai.retryCount).replace("%2$d",window.atai.maxRetries);window.atai.progressHeading.html(`\n            <div style="line-height: 1.4;">\n              <div style="font-weight: 600;">${t}</div>\n            </div>\n          `)}window.atai.isProcessing=!1,r()}),t)}else{if(window.atai.isProcessing=!1,window.atai.retryCount=0,window.atai.progressButtonCancel.length&&window.atai.progressButtonCancel.hide(),window.atai.progressBarWrapper.length&&window.atai.progressBarWrapper.hide(),window.atai.progressButtonFinished.length&&window.atai.progressButtonFinished.show(),window.atai.progressHeading.length){const t=window.atai.retryCount>=window.atai.maxRetries?e("Update stopped after multiple server errors. Your progress has been saved - you can restart to continue.","alttext-ai"):e("Update stopped due to an error. Your progress has been saved - you can restart to continue.","alttext-ai");window.atai.progressHeading.text(t)}alert(e("Bulk generation encountered an error. Your progress has been saved.","alttext-ai"))}}function n(e){return e.split(",").map((function(e){return e.trim()})).filter((function(e){return e.length>0})).slice(0,6)}function s(e){e=e.replace(/[[]/,"\\[").replace(/[\]]/,"\\]");let t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function o(e,t,a){let r=document.getElementById(e);if(!r)return!1;let i=document.getElementById(t+"-"+a);if(i&&i.remove(),!window.location.href.includes("upload.php"))return!1;let n=d(t,a,"modal"),s=r.parentNode;return s&&s.replaceChild(n,r),!0}function d(t,r,i){const s=new URL(window.location.href);s.searchParams.set("atai_action","generate");const o=t+"-"+r,d=document.createElement("div");d.setAttribute("id",o),d.classList.add("description"),d.classList.add("atai-generate-button");const l=document.createElement("a");l.setAttribute("id",o+"-anchor"),l.setAttribute("href",s),l.className="button-secondary button-large atai-generate-button__anchor";const c=document.createElement("div");c.setAttribute("id",o+"-checkbox-wrapper"),c.classList.add("atai-generate-button__keywords-checkbox-wrapper");const u=document.createElement("input");u.setAttribute("type","checkbox"),u.setAttribute("id",o+"-keywords-checkbox"),u.setAttribute("name","atai-generate-button-keywords-checkbox"),u.className="atai-generate-button__keywords-checkbox";const w=document.createElement("label");w.htmlFor="atai-generate-button-keywords-checkbox",w.innerText="Add SEO keywords";const p=document.createElement("div");p.setAttribute("id",o+"-textfield-wrapper"),p.className="atai-generate-button__keywords-textfield-wrapper",p.style.display="none";const g=document.createElement("input");g.setAttribute("type","text"),g.setAttribute("id",o+"-textfield"),g.className="atai-generate-button__keywords-textfield",g.setAttribute("name","atai-generate-button-keywords"),g.size=40,c.appendChild(u),c.appendChild(w),p.appendChild(g),u.addEventListener("change",(function(){this.checked?(p.style.display="block",g.setSelectionRange(0,0),g.focus()):p.style.display="none"}));wp_atai.can_user_upload_files?(e=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai_check_image_eligibility",security:wp_atai.security_check_attachment_eligibility,attachment_id:e},url:wp_atai.ajax_url,success:function(e){if("success"!==e.status){const e=document.querySelector(`#${o}-anchor`),t=document.querySelector(`#${o}-keywords-checkbox`);e?e.classList.add("disabled"):l.classList.add("disabled"),t?t.classList.add("disabled"):u.classList.add("disabled")}}})})(r):(l.classList.add("disabled"),u.disabled=!0),l.title=e("AltText.ai: Update alt text for this single image","alttext-ai"),l.onclick=function(){this.classList.add("disabled");let t=this.querySelector("span");t&&(t.innerText=e("Processing...","alttext-ai"))};const y=document.createElement("img");y.src=wp_atai.icon_button_generate,y.alt=e("Update Alt Text with AltText.ai","alttext-ai"),l.appendChild(y);const h=document.createElement("span");h.innerText=e("Update Alt Text","alttext-ai"),l.appendChild(h),d.appendChild(l),d.appendChild(c),d.appendChild(p);const m=document.createElement("span");return m.classList.add("atai-update-notice"),d.appendChild(m),l.addEventListener("click",(async function(t){t.preventDefault(),wp_atai.has_api_key||(window.location.href=wp_atai.settings_page_url+"&api_key_missing=1");const s="single"==i?document.getElementById("title"):document.querySelector('[data-setting="title"] input'),o="single"==i?document.getElementById("attachment_caption"):document.querySelector('[data-setting="caption"] textarea'),d="single"==i?document.getElementById("attachment_content"):document.querySelector('[data-setting="description"] textarea'),c="single"==i?document.getElementById("attachment_alt"):document.querySelector('[data-setting="alt"] textarea'),w=u.checked?n(g.value):[];m&&(m.innerText="",m.classList.remove("atai-update-notice--success","atai-update-notice--error"));const p=await a(r,w);if("success"===p.status)c.value=p.alt_text,"yes"===wp_atai.should_update_title&&(s.value=p.alt_text,"single"==i&&s.previousElementSibling.classList.add("screen-reader-text")),"yes"===wp_atai.should_update_caption&&(o.value=p.alt_text),"yes"===wp_atai.should_update_description&&(d.value=p.alt_text),m.innerText=e("Updated","alttext-ai"),m.classList.add("atai-update-notice--success"),setTimeout((()=>{m.classList.remove("atai-update-notice--success")}),3e3);else{let t=e("Unable to generate alt text. Check error logs for details.","alttext-ai");p?.message&&(t=p.message),m.innerText=t,m.classList.add("atai-update-notice--error")}l.classList.remove("disabled"),l.querySelector("span").innerText=e("Update Alt Text","alttext-ai")})),d}function l(e,t,a){try{if(e.querySelector("#atai-generate-button-"+t+", .atai-generate-button"))return!0;let r,i=!1;const n=e.querySelector("p#alt-text-description");if(n&&n.parentNode&&(r=d("atai-generate-button",t,a),n.parentNode.replaceChild(r,n),i=!0),!i){const n=e.querySelector('[data-setting="alt"] input, [data-setting="alt"] textarea');n&&n.parentNode&&(r=d("atai-generate-button",t,a),n.parentNode.insertBefore(r,n.nextSibling),i=!0)}if(!i){const n=e.querySelector(".attachment-details, .media-attachment-details");n&&(r=d("atai-generate-button",t,a),n.appendChild(r),i=!0)}return i||(r=d("atai-generate-button",t,a),e.appendChild(r),i=!0),i}catch(e){return console.error("[AltText.ai] Error injecting button:",e),!1}}function c(e,t,a){if("button-click"===t&&!e.target.matches(".media-modal .right, .media-modal .left"))return;const r=new URLSearchParams(window.location.search).get("item");r&&o("alt-text-description",a,r)}jQuery("[data-edit-history-trigger]").on("click",(async function(){const t=this,a=t.dataset.attachmentId,r=document.getElementById("edit-history-input-"+a).value.replace(/\n/g,"");t.disabled=!0;try{const t=await function(t,a=""){if(!t){const t=new Error(e("Attachment ID is missing","alttext-ai"));return console.error("editHistoryAJAX error:",t),Promise.reject(t)}return new Promise(((e,r)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai_edit_history",security:wp_atai.security_edit_history,attachment_id:t,alt_text:a},url:wp_atai.ajax_url,success:function(t){e(t)},error:function(e){const t=new Error("AJAX request failed");console.error("editHistoryAJAX failed:",t),r(t)}})}))}(a,r);"success"!==t.status&&alert(e("Unable to update alt text for this image.","alttext-ai"));const i=document.getElementById("edit-history-success-"+a);i.classList.remove("hidden"),setTimeout((()=>{i.classList.add("hidden")}),2e3)}catch(t){alert(e("An error occurred while updating the alt text.","alttext-ai"))}finally{t.disabled=!1}})),jQuery("[data-bulk-generate-start]").on("click",(function(){const t=s("atai_action")||"normal",a=s("atai_batch_id")||0;if("bulk-select-generate"!==t||a||alert(e("Invalid batch ID","alttext-ai")),window.atai.bulkGenerateKeywords=n(jQuery("[data-bulk-generate-keywords]").val()??""),window.atai.bulkGenerateNegativeKeywords=n(jQuery("[data-bulk-generate-negative-keywords]").val()??""),window.atai.progressWrapperEl=jQuery("[data-bulk-generate-progress-wrapper]"),window.atai.progressHeading=jQuery("[data-bulk-generate-progress-heading]"),window.atai.progressBarWrapper=jQuery("[data-bulk-generate-progress-bar-wrapper]"),window.atai.progressBarEl=jQuery("[data-bulk-generate-progress-bar]"),window.atai.progressPercent=jQuery("[data-bulk-generate-progress-percent]"),window.atai.progressLastPostId=jQuery("[data-bulk-generate-last-post-id]"),window.atai.progressCurrentEl=jQuery("[data-bulk-generate-progress-current]"),void 0===window.atai.progressCurrent&&(window.atai.progressCurrent=window.atai.progressBarEl.length?window.atai.progressBarEl.data("current"):0),window.atai.progressSuccessfulEl=jQuery("[data-bulk-generate-progress-successful]"),void 0===window.atai.progressSuccessful&&(window.atai.progressSuccessful=window.atai.progressBarEl.length?window.atai.progressBarEl.data("successful"):0),window.atai.progressSkippedEl=jQuery("[data-bulk-generate-progress-skipped]"),void 0===window.atai.progressSkipped&&(window.atai.progressSkipped=0),void 0===window.atai.progressMax&&(window.atai.progressMax=window.atai.progressBarEl.length?window.atai.progressBarEl.data("max"):100),window.atai.progressButtonCancel=jQuery("[data-bulk-generate-cancel]"),window.atai.progressButtonFinished=jQuery("[data-bulk-generate-finished]"),"bulk-select-generate"===t?(window.atai.bulkGenerateMode="bulk-select",window.atai.bulkGenerateBatchId=a):(window.atai.bulkGenerateMode=jQuery("[data-bulk-generate-mode-all]").is(":checked")?"all":"missing",window.atai.bulkGenerateOnlyAttached=jQuery("[data-bulk-generate-only-attached]").is(":checked")?"1":"0",window.atai.bulkGenerateOnlyNew=jQuery("[data-bulk-generate-only-new]").is(":checked")?"1":"0",window.atai.bulkGenerateWCProducts=jQuery("[data-bulk-generate-wc-products]").is(":checked")?"1":"0",window.atai.bulkGenerateWCOnlyFeatured=jQuery("[data-bulk-generate-wc-only-featured]").is(":checked")?"1":"0"),jQuery("#bulk-generate-form").hide(),window.atai.hideButtons(),window.atai.progressWrapperEl.length&&window.atai.progressWrapperEl.show(),window.atai.isContinuation){const t=window.atai.lastPostId||0;if(window.atai.progressBarEl.length){window.atai.progressBarEl.data("current",window.atai.progressCurrent),window.atai.progressBarEl.data("successful",window.atai.progressSuccessful),window.atai.progressBarEl.data("max",window.atai.progressMax),window.atai.progressCurrentEl.length&&window.atai.progressCurrentEl.text(window.atai.progressCurrent),window.atai.progressSuccessfulEl.length&&window.atai.progressSuccessfulEl.text(window.atai.progressSuccessful),window.atai.progressSkippedEl.length&&window.atai.progressSkippedEl.text(window.atai.progressSkipped||0);const e=100*window.atai.progressCurrent/window.atai.progressMax;window.atai.progressBarEl.css("width",e+"%"),window.atai.progressPercent.length&&window.atai.progressPercent.text(Math.round(e)+"%")}const a=jQuery('<div class="notice notice-success" style="margin: 15px 0; padding: 10px 15px; border-left: 4px solid #00a32a;"><p style="margin: 0; font-weight: 500;"><span class="dashicons dashicons-update" style="margin-right: 5px;"></span>'+e("Resuming from where you left off - starting after image ID %d","alttext-ai").replace("%d",t)+"</p></div>");jQuery(".wrap.max-w-6xl").find("#bulk-generate-form").before(a),window.atai.progressHeading.length&&window.atai.progressHeading.text(e("Continuing bulk generation from image ID %d...","alttext-ai").replace("%d",t))}r()})),jQuery("[data-bulk-generate-mode-all]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-only-attached]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-only-new]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-wc-products]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-bulk-generate-wc-only-featured]").on("change",(function(){window.location.href=this.dataset.url})),jQuery("[data-post-bulk-generate]").on("click",(async function(t){if("#atai-bulk-generate"!==this.getAttribute("href"))return;if(t.preventDefault(),function(){try{if(window.wp&&wp.data&&wp.blocks)return wp.data.select("core/editor").isEditedPostDirty()}catch(e){return console.error("Error checking if post is dirty:",e),!0}return!0}()){if(!confirm(e("[AltText.ai] Make sure to save any changes before proceeding -- any unsaved changes will be lost. Are you sure you want to continue?","alttext-ai")))return}const a=document.getElementById("post_ID")?.value,r=this.querySelector("span"),i=this.nextElementSibling,s=r.innerText,o=document.querySelector("[data-post-bulk-generate-overwrite]")?.checked||!1,d=document.querySelector("[data-post-bulk-generate-process-external]")?.checked||!1,l=document.querySelector("[data-post-bulk-generate-keywords-checkbox]"),c=document.querySelector("[data-post-bulk-generate-keywords]"),u=l?.checked?n(c?.value):[];if(!a)return i.innerText=e("This is not a valid post.","alttext-ai"),void i.classList.add("atai-update-notice--error");try{this.classList.add("disabled"),r.innerText=e("Processing...","alttext-ai");const t=await function(t,a=!1,r=!1,i=[]){if(!t){const t=new Error(e("Post ID is missing","alttext-ai"));return console.error("enrichPostContentAJAX error:",t),Promise.reject(t)}return new Promise(((e,n)=>{jQuery.ajax({type:"post",dataType:"json",data:{action:"atai_enrich_post_content",security:wp_atai.security_enrich_post_content,post_id:t,overwrite:a,process_external:r,keywords:i},url:wp_atai.ajax_url,success:function(t){e(t)},error:function(e){const t=new Error("AJAX request failed");console.error("enrichPostContentAJAX failed:",t),n(t)}})}))}(a,o,d,u);if(!t.success)throw new Error(e("Unable to generate alt text. Check error logs for details.","alttext-ai"));window.location.reload()}catch(t){i.innerText=t.message||e("An error occurred.","alttext-ai"),i.classList.add("atai-update-notice--error")}finally{this.classList.remove("disabled"),r.innerText=s}})),document.addEventListener("DOMContentLoaded",(()=>{wp?.blocks&&jQuery.ajax({url:wp_atai.ajax_url,type:"GET",data:{action:"atai_check_enrich_post_content_transient",security:wp_atai.security_enrich_post_content_transient},success:function(e){e?.success&&wp.data.dispatch("core/notices").createNotice("success",e.data.message,{isDismissible:!0})}})})),jQuery('[name="handle_api_key"]').on("click",(function(){"Clear API Key"===this.value&&jQuery('[name="atai_api_key"]').val("")})),jQuery(".notice--atai.is-dismissible").on("click",".notice-dismiss",(function(){jQuery.ajax(wp_atai.ajax_url,{type:"POST",data:{action:"atai_expire_insufficient_credits_notice",security:wp_atai.security_insufficient_credits_notice}})})),document.addEventListener("DOMContentLoaded",(async()=>{const e=window.location.href.includes("post.php")&&jQuery("body").hasClass("post-type-attachment"),t=window.location.href.includes("post-new.php")||window.location.href.includes("post.php")&&!jQuery("body").hasClass("post-type-attachment"),a=window.location.href.includes("upload.php");let r=null,i="atai-generate-button";if(e){if(r=s("post"),!r)return!1;if(r=parseInt(r,10),!r)return;let e=document.getElementsByClassName("attachment-alt-text")[0];if(e){let t=d(i,r,"single");setTimeout((()=>{!function(e,t){if(e.hasChildNodes()){for(const a of e.childNodes)if("BUTTON"==a.nodeName)return void e.replaceChild(t,a);e.appendChild(t)}else e.appendChild(t)}(e,t)}),200)}}else{if(!a&&!t)return!1;if(r=s("item"),jQuery(document).on("click","ul.attachments li.attachment",(function(){let e=jQuery(this);e.attr("data-id")&&(r=parseInt(e.attr("data-id"),10),r&&o("alt-text-description",i,r))})),document.addEventListener("click",(function(e){c(e,"button-click",i)})),document.addEventListener("keydown",(function(e){"ArrowRight"!==e.key&&"ArrowLeft"!==e.key||c(e,"keyboard",i)})),!r)return!1}})),document.addEventListener("DOMContentLoaded",(()=>{jQuery('.tablenav .bulkactions select option[value="alttext_options"]').attr("disabled","disabled")}));function u(){const t=wp.media.view.Attachment.Details;wp.media.view.Attachment.Details=t.extend({ATAICheckboxToggle:function(e){const t=e.currentTarget,a=t.parentNode.nextElementSibling,r=a.querySelector(".atai-generate-button__keywords-textfield");t.checked?(a.style.display="block",r.setSelectionRange(0,0),r.focus()):a.style.display="none"},ATAIAnchorClick:async function(t){t.preventDefault();const r=this.model.id,i=t.currentTarget,s=i.closest(".attachment-details"),o=i.closest(".atai-generate-button"),d=o.querySelector(".atai-generate-button__keywords-checkbox"),l=o.querySelector(".atai-generate-button__keywords-textfield"),c=o.querySelector(".atai-update-notice");i.classList.add("disabled");const u=i.querySelector("span");u&&(u.innerText=e("Processing...","alttext-ai")),wp_atai.has_api_key||(window.location.href=wp_atai.settings_page_url+"&api_key_missing=1");const w=s.querySelector('[data-setting="title"] input'),p=s.querySelector('[data-setting="caption"] textarea'),g=s.querySelector('[data-setting="description"] textarea'),y=s.querySelector('[data-setting="alt"] textarea'),h=d.checked?n(l.value):[];c&&(c.innerText="",c.classList.remove("atai-update-notice--success","atai-update-notice--error"));const m=await a(r,h);if("success"===m.status)y.value=m.alt_text,"yes"===wp_atai.should_update_title&&(w.value=m.alt_text),"yes"===wp_atai.should_update_caption&&(p.value=m.alt_text),"yes"===wp_atai.should_update_description&&(g.value=m.alt_text),c.innerText=e("Updated","alttext-ai"),c.classList.add("atai-update-notice--success"),setTimeout((()=>{c.classList.remove("atai-update-notice--success")}),3e3);else{let t=e("Unable to generate alt text. Check error logs for details.","alttext-ai");m?.message&&(t=m.message),c.innerText=t,c.classList.add("atai-update-notice--error")}i.classList.remove("disabled"),u.innerText=e("Update Alt Text","alttext-ai")},events:{...t.prototype.events,"change .atai-generate-button__keywords-checkbox":"ATAICheckboxToggle","click .atai-generate-button__anchor":"ATAIAnchorClick"},template:function(e){const a=t.prototype.template.apply(this,arguments),r=document.createElement("div");return r.innerHTML=a,l(r,e.model.id,"modal"),r.innerHTML}})}(()=>{if(wp?.media?.view?.Attachment?.Details?.prototype?.render){const e=wp.media.view.Attachment.Details.prototype.render;wp.media.view.Attachment.Details.prototype.render=function(){const t=e.apply(this,arguments),a=this.$el?this.$el[0]:null;if(a){this._ataiObserver&&(this._ataiObserver.disconnect(),delete this._ataiObserver);let e=null;const t=()=>{e&&clearTimeout(e),e=setTimeout((()=>{a.querySelector(".atai-generate-button")||l(a,this.model.get("id"),"modal"),this._ataiObserver&&(this._ataiObserver.disconnect(),delete this._ataiObserver)}),50)};this._ataiObserver=new MutationObserver(t),this._ataiObserver.observe(a,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),setTimeout((()=>{a.querySelector(".atai-generate-button")||l(a,this.model.get("id"),"modal")}),10)}return t}}})(),document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelector("form#alttextai-csv-import");if(e){const t=e.querySelector('input[type="file"]');t&&t.addEventListener("change",(t=>{e.dataset.fileLoaded=t.target.files?.length>0?"true":"false"}))}})),document.addEventListener("DOMContentLoaded",(()=>{wp?.media?.view?.Attachment?.Details&&setTimeout(u,500)}))}();
